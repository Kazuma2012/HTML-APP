
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>イコライザーPRO MAX</title>
<style>
  body { background:#111; margin:0; display:flex; justify-content:center; align-items:center; height:100vh; font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
  .panel { display:flex; gap:20px; background: linear-gradient(145deg, #2b2b2b, #1a1a1a); padding: 70px 40px 24px; border-radius: 14px; box-shadow: inset 0 0 15px rgba(0,0,0,0.8), 0 12px 20px rgba(0,0,0,0.7); overflow-x: auto; position: relative; }
  .fader-unit { display:flex; flex-direction: column; align-items: center; width: 60px; user-select:none; }
  .label { color:#ddd; font-size: 13px; margin-bottom: 4px; letter-spacing: 1px; }
  .value-label { color:#0f0; font-size: 18px; font-weight: bold; background: #000; border: 2px inset #0f0; padding: 4px 8px; border-radius: 4px; text-align: center; margin-bottom: 10px; min-width: 40px; box-shadow: 0 0 6px #0f0; font-family: 'Courier New', monospace; }
  .fader-rail { position: relative; width: 50px; height: 450px; border-radius: 12px; background: repeating-linear-gradient(to bottom,#444,#444 2px,#333 3px,#333 5px); box-shadow: inset 0 2px 6px #222,inset 0 -2px 5px #555; margin: 0 auto; touch-action: none; }
  .fader-rail::before { content: ''; position: absolute; left: 50%; top: 0; transform: translateX(-50%); width: 3px; height: 100%; background: #666; box-shadow: 0 0 4px 1px #444 inset; }
  .marks { position: absolute; left: 50%; top: 0; transform: translateX(-50%); width: 40px; height: 100%; pointer-events:none; }
  .marks span { position: absolute; left: 100%; width: 8px; height: 1.5px; background: #bbb; }
  .marks span:nth-child(1) {top: 0%;} .marks span:nth-child(2) {top: 10%;} .marks span:nth-child(3) {top: 20%;} .marks span:nth-child(4) {top: 30%;} .marks span:nth-child(5) {top: 40%;} .marks span:nth-child(6) {top: 50%;} .marks span:nth-child(7) {top: 60%;} .marks span:nth-child(8) {top: 70%;} .marks span:nth-child(9) {top: 80%;} .marks span:nth-child(10) {top: 90%;} .marks span:nth-child(11) {top: 99%;}
  .fader-thumb { position: absolute; left: 50%; width: 30px; height: 50px; background: repeating-linear-gradient(0deg,#222 0,#222 1px,#333 2px,#222 3px); border-radius: 15px 15px 10px 10px; border: 1.5px solid #111; box-shadow: inset 0 2px 6px #666,0 2px 5px rgba(0,0,0,0.9),0 1px 0 1px rgba(255,255,255,0.1) inset; cursor: pointer; transform: translateX(-50%); user-select:none; }
  .fader-thumb::before { content: ''; position: absolute; top: 50%; left: 10%; width: 80%; height: 2.5px; background: red; border-radius: 1.5px; transform: translateY(-50%); pointer-events: none; }
  .btn-row { display: flex; flex-direction: column; gap: 10px; margin-top: 14px; align-items: center; }
  .btn { width: 45px; height: 45px; background: #111; border: 2px solid #222; border-radius: 8px; box-shadow: inset 0 0 4px 2px #0f0,0 2px 4px rgba(0,255,0,0.7); cursor: pointer; transition: box-shadow 0.3s ease, background 0.3s ease, border-color 0.3s ease; position: relative; user-select:none; }
  .btn.active,.btn:active { background: #22ff33; box-shadow: inset 0 0 12px 4px #22ff33cc,0 0 10px 3px #22ff33cc; border-color: #22ff33; color: #000; }
  #audioControls { position: absolute; top: -6px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 5; background: rgba(0,0,0,0.6); padding: 8px 12px; border-radius: 8px; align-items:center; }
 #audioControls audio { width: 100 px; height: 24px; border-radius: 4px; }
</style>
</head>
<body>
<div class="panel" id="controller"></div>
<div id="audioControls">
  <input type="file" id="audioFile" accept="audio/*">
  <audio id="audioPlayer" controls></audio>
</div>

<script>
const controller=document.getElementById('controller');
const faderCount=20;
const maxTop=400;
let dragData=null;
let faderStates={};

let audioCtx, audioPlayer, sourceNode;
let volumeNode;
let eqNodes = [];
let echoNode, reverbNode, reverbGainNode;
let compressorNode; // CH10用コンプレッサー
const fileInput = document.getElementById('audioFile');
audioPlayer = document.getElementById('audioPlayer');

fileInput.addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  if(audioPlayer.src){
    audioPlayer.pause();
    audioPlayer.removeAttribute('src');
  }

  audioPlayer.src = URL.createObjectURL(file);
  audioPlayer.crossOrigin = "anonymous";
  audioPlayer.load();

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  audioCtx.resume();

  sourceNode = audioCtx.createMediaElementSource(audioPlayer);

  volumeNode = audioCtx.createGain();
  volumeNode.gain.value = 0.5;

  echoNode = audioCtx.createDelay();
  echoNode.delayTime.value = 0;

  reverbNode = audioCtx.createConvolver();
  const irBuffer = audioCtx.createBuffer(2, audioCtx.sampleRate, audioCtx.sampleRate);
  for(let c=0;c<2;c++){
    const data = irBuffer.getChannelData(c);
    for(let i=0;i<data.length;i++){
      data[i] = (Math.random()*2-1)*Math.pow(1-i/data.length,2);
    }
  }
  reverbNode.buffer = irBuffer;
  reverbGainNode = audioCtx.createGain();
  reverbGainNode.gain.value = 0;

  const eqSettings = [
    { type: "lowshelf",  freq: 60 },
    { type: "peaking",   freq: 250 },
    { type: "peaking",   freq: 1000 },
    { type: "peaking",   freq: 4000 },
    { type: "highshelf", freq: 10000 }
  ];
  eqNodes = eqSettings.map(s=>{
    const f = audioCtx.createBiquadFilter();
    f.type = s.type;
    f.frequency.value = s.freq;
    f.gain.value = 0;
    f.Q.value = 1.4;
    return f;
  });

  compressorNode = audioCtx.createDynamicsCompressor();
  updateCompressor(0); // 初期値0%

  sourceNode.connect(volumeNode);
  volumeNode.connect(echoNode);

  echoNode.connect(eqNodes[0]);
  echoNode.connect(reverbNode);
  reverbNode.connect(reverbGainNode);
  reverbGainNode.connect(eqNodes[0]);

  for(let i=0;i<eqNodes.length-1;i++){ eqNodes[i].connect(eqNodes[i+1]); }
  eqNodes[eqNodes.length-1].connect(compressorNode);
  compressorNode.connect(audioCtx.destination);
});

function updateCompressor(percent){
  const t = audioCtx.currentTime;
  compressorNode.threshold.setValueAtTime(-40 * (percent/100), t);
  compressorNode.ratio.setValueAtTime(1 + 19 * (percent/100), t);
  compressorNode.knee.setValueAtTime(40 * (percent/100), t);
  compressorNode.attack.setValueAtTime(0.05 - 0.049*(percent/100), t);
  compressorNode.release.setValueAtTime(0.05 + 0.45*(percent/100), t);
}

function createMarks(){ const marks=document.createElement('div'); marks.className='marks'; for(let i=0;i<=10;i++){ const mark=document.createElement('span'); marks.appendChild(mark); } return marks; }

function updateValue(thumb){
  let top=parseFloat(thumb.style.top);
  let percent=Math.round((1-top/maxTop)*100);
  const unit=thumb.closest('.fader-unit');
  const valueLabel=unit.querySelector('.value-label');
  const label=unit.querySelector('.label').textContent;

  valueLabel.textContent=percent+'%';

  let dB = 0;
  if(label==='Volume'||['Sub','Low','Mid','High','Higher'].includes(label)){
    if(label==='Sub' || label==='Higher'){
      dB = (percent-50)*0.6; 
    } else {
      dB = (percent-50)*0.48; 
    }
  }

  const gain=Math.pow(10,dB/20);

  if(label==='Volume'){ if(volumeNode) volumeNode.gain.value=gain; }
  else if(['Sub','Low','Mid','High','Higher'].includes(label)){
    const eqIndex=['Sub','Low','Mid','High','Higher'].indexOf(label);
    if(eqIndex>=0) eqNodes[eqIndex].gain.value=dB;
  }
  else if(label==='Speed'){ audioPlayer.playbackRate = percent / 50; }
  else if(label==='Echo'){ if(echoNode) echoNode.delayTime.value = (percent/100) * 0.5; }
  else if(label==='Reverb'){ if(reverbGainNode) reverbGainNode.gain.value = percent/100; }
  else if(label==='Compressor'){ if(compressorNode) updateCompressor(percent); }

  if(label.startsWith('CH ')){
    const ch=parseInt(label.replace('CH ',''));
    const setNum=Math.ceil(ch/5);
    const channel=new BroadcastChannel('dmx-control-set'+setNum);
    channel.postMessage({ch,value:percent});
  }
}

function setFaderValue(thumb,percent){ let newTop=maxTop-(percent/100*maxTop); if(newTop<0)newTop=0; if(newTop>maxTop)newTop=maxTop; thumb.style.top=newTop+'px'; updateValue(thumb); }

function autoMove(thumb,ch,direction){
  clearInterval(faderStates[ch]?.interval);
  faderStates[ch]={auto:direction,interval:null};
  faderStates[ch].interval=setInterval(()=>{
    let top=parseFloat(thumb.style.top);
    let percent=Math.round((1-top/maxTop)*100);
    if(direction==='up'){ if(percent>=100){ clearInterval(faderStates[ch].interval); faderStates[ch].auto=null; } else { setFaderValue(thumb,percent+1); } }
    if(direction==='down'){ if(percent<=0){ clearInterval(faderStates[ch].interval); faderStates[ch].auto=null; } else { setFaderValue(thumb,percent-1); } }
  },150);
}

const eqLabels=['Volume','Higher','High','Mid','Low','Sub','Speed','Echo','Reverb'];

for(let i=1;i<=faderCount;i++){
  const unit=document.createElement('div'); unit.className='fader-unit';
  const label=document.createElement('div'); label.className='label';

  if(i<=9) label.textContent = eqLabels[i-1];
  else if(i===10) label.textContent = 'Compressor'; // CH10
  else label.textContent = 'CH '+i;
  unit.appendChild(label);

  const valueLabel=document.createElement('div'); valueLabel.className='value-label';
  if(label.textContent === 'Speed') valueLabel.textContent = '50%';
  else if(label.textContent === 'Compressor') valueLabel.textContent = '0%';
  else valueLabel.textContent=i<=9?'50%':'0%';
  unit.appendChild(valueLabel);

  const rail=document.createElement('div'); rail.className='fader-rail'; rail.appendChild(createMarks());
  const thumb=document.createElement('div'); thumb.className='fader-thumb';

  if(label.textContent === 'Speed') thumb.style.top = maxTop/2+'px';
  else if(label.textContent === 'Compressor') thumb.style.top = maxTop+'px';
  else thumb.style.top=i<=6 ? maxTop/2+'px' : maxTop+'px';

  rail.appendChild(thumb);
  unit.appendChild(rail);

  const btnRow=document.createElement('div'); btnRow.className='btn-row';
  for(let b=0;b<2;b++){
    const btn=document.createElement('button'); btn.className='btn'; btn.dataset.btn=b;
    btn.addEventListener('click',()=>{
      const ch=i;
      if(b===0){ let top=parseFloat(thumb.style.top); let percent=Math.round((1-top/maxTop)*100); if(percent<100){ setFaderValue(thumb,100); } else { setFaderValue(thumb,0); } }
      else { let state=faderStates[ch]?.auto||null;
        if(state===null){ autoMove(thumb,ch,'up'); }
        else if(state==='up'){ clearInterval(faderStates[ch].interval); faderStates[ch].auto='stoppedUp'; }
        else if(state==='stoppedUp'){ autoMove(thumb,ch,'down'); }
        else if(state==='down'){ clearInterval(faderStates[ch].interval); faderStates[ch].auto='stoppedDown'; }
        else if(state==='stoppedDown'){ autoMove(thumb,ch,'up'); }
      }
    });
    btnRow.appendChild(btn);
  }
  unit.appendChild(btnRow);
  controller.appendChild(unit);

  thumb.addEventListener('mousedown',(e)=>{ e.preventDefault(); dragData={thumb,startY:e.clientY,startTop:parseFloat(thumb.style.top)}; document.addEventListener('mousemove',onDrag); document.addEventListener('mouseup',onStopDrag); });
  thumb.addEventListener('touchstart',(e)=>{ e.preventDefault(); const touch=e.touches[0]; dragData={thumb,startY:touch.clientY,startTop:parseFloat(thumb.style.top)}; document.addEventListener('touchmove',onDragTouch,{passive:false}); document.addEventListener('touchend',onStopDragTouch); document.addEventListener('touchcancel',onStopDragTouch); });
}

function onDrag(e){ if(!dragData) return; const {thumb,startY,startTop}=dragData; let delta=e.clientY-startY; let newTop=startTop+delta; if(newTop<0)newTop=0; if(newTop>maxTop)newTop=maxTop; thumb.style.top=newTop+'px'; updateValue(thumb); }
function onStopDrag(){ if(!dragData)return; document.removeEventListener('mousemove',onDrag); document.removeEventListener('mouseup',onStopDrag); dragData=null; }
function onDragTouch(e){ e.preventDefault(); if(!dragData)return; const touch=e.touches[0]; const {thumb,startY,startTop}=dragData; let delta=touch.clientY-startY; let newTop=startTop+delta; if(newTop<0)newTop=0; if(newTop>maxTop)newTop=maxTop; thumb.style.top=newTop+'px'; updateValue(thumb); }
function onStopDragTouch(){ document.removeEventListener('touchmove',onDragTouch); document.removeEventListener('touchend',onStopDragTouch); document.removeEventListener('touchcancel',onStopDragTouch); dragData=null; }

document.addEventListener('keydown', (e)=>{
  if(e.code === 'Space'){ 
    e.preventDefault(); 
    if(audioPlayer.paused){ audioPlayer.play(); } else { audioPlayer.pause(); }
  }
});
</script>
</body>
</html>
