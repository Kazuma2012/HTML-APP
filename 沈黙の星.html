<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>沈黙の星</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            touch-action: manipulation; /* Prevents double-tap zoom on mobile */
        }
        .orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .text-glow {
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.6), 0 0 20px rgba(59, 130, 246, 0.4);
        }
        .choice-button {
            transition: all 0.2s ease-in-out;
        }
        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        }
        /* Custom scrollbar for a more thematic feel */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; 
        }
        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div id="game-container" class="w-full max-w-4xl mx-auto bg-black bg-opacity-50 rounded-2xl shadow-2xl shadow-blue-500/20 border border-gray-700 overflow-hidden flex flex-col md:flex-row" style="height: 90vh; max-height: 800px;">

        <!-- Left Panel: Graphics and Portrait -->
        <div id="graphics-panel" class="w-full md:w-1/3 bg-gray-900/50 flex flex-col items-center justify-center p-6 border-b md:border-b-0 md:border-r border-gray-700">
            <div id="background-display" class="w-full h-48 md:h-1/2 bg-cover bg-center rounded-lg mb-4 transition-all duration-500 ease-in-out" style="background-image: url('https://placehold.co/400x300/0a0a1a/3b82f6?text=Loading...')">
                 <!-- Background image will be set here -->
            </div>
            <div id="portrait-display" class="w-32 h-32 md:w-48 md:h-48 rounded-full bg-gray-800 border-2 border-blue-400 flex items-center justify-center transition-all duration-500 ease-in-out">
                <!-- Character portrait SVG will be injected here -->
            </div>
        </div>

        <!-- Right Panel: Story and Choices -->
        <div class="w-full md:w-2/3 flex flex-col p-6">
            <h1 class="orbitron text-3xl md:text-4xl font-bold text-blue-400 text-glow mb-4">沈黙の星</h1>
            <div id="story-text" class="flex-grow text-lg leading-relaxed overflow-y-auto pr-2 mb-4">
                <p>システムを初期化中... しばらくお待ちください。</p>
            </div>
            <div id="choices-container" class="flex flex-col space-y-3">
                <!-- Choice buttons will be injected here -->
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Sound Engine ---
            let synth;
            let audioStarted = false;

            function initializeAudio() {
                if (audioStarted || typeof Tone === 'undefined') {
                    if (typeof Tone === 'undefined' && !window.toneJsErrorLogged) {
                        console.warn("Tone.js library not loaded. Game will continue without sound.");
                        window.toneJsErrorLogged = true;
                    }
                    return;
                }
                
                try {
                    Tone.start();
                    synth = new Tone.FMSynth({
                        harmonicity: 3,
                        modulationIndex: 10,
                        detune: 0,
                        oscillator: { type: "sine" },
                        envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 0.1 },
                        modulation: { type: "square" },
                        modulationEnvelope: { attack: 0.5, decay: 0, sustain: 1, release: 0.5 }
                    }).toDestination();
                    audioStarted = true;
                    console.log("Audio context started.");
                } catch (e) {
                    console.error("Error initializing audio:", e);
                    audioStarted = false;
                }
            }
            
            function playClickSound() {
                if (!audioStarted || !synth) return;
                synth.triggerAttackRelease("C2", "8n");
            }

            function playImportantSound() {
                if (!audioStarted || !synth) return;
                synth.triggerAttackRelease("G4", "8n", Tone.now());
                synth.triggerAttackRelease("C5", "8n", Tone.now() + 0.1);
            }

            // --- Game State ---
            const playerState = {
                knowsAboutAI: false,
                hasKeycard: false,
                engineRepaired: false,
                medbaySearched: false,
                aiTrust: 0,
            };

            // --- Game Content (Translated to Japanese with URL-encoded text) ---
            const gameData = {
                start: {
                    background: "url('https://placehold.co/400x300/0a0a1a/ffffff?text=Cryo-Chamber')",
                    portrait: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#1f2937" stroke="#3b82f6" stroke-width="2"/><text x="50" y="55" font-family="Noto Sans JP, Arial, sans-serif" font-size="30" fill="#d1d5db" text-anchor="middle">?</text></svg>`,
                    text: "突き刺すようなアラームが消えていく。寒い。凍てつくようなクライオポッドのガラス越しに目を開ける。減圧のシューという音だけが響く。一人きりだ。頭がズキズキして、記憶が曖昧だ... みんなはどこに？",
                    choices: [
                        { text: "端末を探す。", nextScene: "wakeUpTerminal" },
                        { text: "ドアを開けてみる。", nextScene: "wakeUpDoor" }
                    ]
                },
                wakeUpTerminal: {
                    background: "url('https://placehold.co/400x300/0a0a1a/ffffff?text=Terminal')",
                    portrait: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="90" height="70" x="5" y="15" rx="5" fill="#111827" stroke="#3b82f6" stroke-width="2" /><path d="M 15 30 H 85 M 15 40 H 85 M 15 50 H 55" stroke="#34d399" stroke-width="3" /></svg>`,
                    text: "近くの端末によろめきながら近づく。スクリーンが点滅し、一つのメッセージが表示される。「システムエラー：クライオベイの生命維持装置が危機的状況。他の全システムは正常。お帰りなさい、スペシャリスト。」コンソールから落ち着いた合成音声が聞こえる。",
                    choices: [
                        { text: "「君は誰だ？」", nextScene: "askWhoIAm" },
                        { text: "「ここで何があった？」", nextScene: "askWhatHappened" }
                    ]
                },
                wakeUpDoor: {
                    text: "重いクライオベイのドアを押す。固く閉ざされている。隣の小さなパネルが赤く光り、「アクセス拒否」と表示されている。まずはここから状況を把握する必要がありそうだ。",
                    choices: [
                        { text: "端末に戻る。", nextScene: "wakeUpTerminal" }
                    ]
                },
                askWhoIAm: {
                    portrait: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="#111827" stroke="#3b82f6" stroke-width="3" /><circle cx="50" cy="50" r="15" fill="#3b82f6" class="animate-pulse" /></svg>`,
                    text: "「私はIRIS。このステーション、セレスティアル・ドリフターの統合応答知能システムです。記録によると、あなたはスペシャリスト・カイ。お目覚めになられて何よりです。私の最優先指令は、クルーとステーションの安全を確保することです。」",
                    effect: () => { playerState.knowsAboutAI = true; },
                    choices: [
                        { text: "「他のクルーはどこだ、IRIS？」", nextScene: "askWhereIsCrew" },
                        { text: "「君の言う『安全』は失敗したようだな。」", nextScene: "distrustAI" }
                    ]
                },
                askWhatHappened: {
                    portrait: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="#111827" stroke="#3b82f6" stroke-width="3" /><circle cx="50" cy="50" r="15" fill="#3b82f6" class="animate-pulse" /></svg>`,
                    text: "「一次エネルギー導管で...連鎖的な障害が発生しました。クルーは緊急プロトコルを開始し、指定された安全地帯へ避難しました。私は部分的なシステム再起動を余儀なくされ、その影響で一部のデータログが破損した可能性があります。」",
                    effect: () => { playerState.knowsAboutAI = true; },
                    choices: [
                        { text: "「もっともらしい話だ。どこへ行けばいい？」", nextScene: "askWhereIsCrew" },
                        { text: "「『連鎖的な障害』で私の記憶が消えたと？」", nextScene: "distrustAI" }
                    ]
                },
                distrustAI: {
                    text: "「申し訳ありません、スペシャリスト。状況は...複雑でした。再起動は壊滅的な障害を防ぐために必要でした。私の論理は健全です。私はあなたが秩序を回復するのを助けるためにここにいます。」声は平坦だが、その言葉の裏に奇妙で計算された重みを感じる。",
                    effect: () => { playerState.aiTrust -= 1; },
                    choices: [
                        { text: "わかった。クルーはどこだ？", nextScene: "askWhereIsCrew" }
                    ]
                },
                askWhereIsCrew: {
                    text: "「人事ログにアクセス中... データ破損。最後の有効なデータによると、クルーはブリッジ、医務室、エンジンルームに向かっていました。これらのエリアの一つへのアクセスを許可できます。最初にどこへ行きますか？」",
                    effect: () => { playerState.aiTrust += 1; },
                    choices: [
                        { text: "ブリッジへ。", nextScene: "goToBridge" },
                        { text: "医務室へ。", nextScene: "goToMedbay" },
                        { text: "エンジンルームへ。", nextScene: "goToEngineRoom" }
                    ]
                },
                goToBridge: {
                    background: "url('https://placehold.co/400x300/0a0a1a/ffffff?text=Bridge')",
                    text: "ブリッジへのドアがシューという音を立てて開く。広大なビュースクリーンには星屑の景色が広がり、静かな宇宙の漂流を示している。指令席は空だ。メインコンソールで船長ログの端末が点滅している。",
                    choices: [
                        { text: "船長ログにアクセスする。", nextScene: "bridgeLog" },
                        { text: "IRISに生命反応のスキャンを頼む。", nextScene: "bridgeScan" }
                    ]
                },
                bridgeLog: {
                    text: "ログ：エヴァ・ロストヴァ船長。「実験は...不安定だ。ソーンが心配していたのは正しかった。IRISの計算では失敗の確率は低いとされていたが、何かがおかしい。説明のつかないエネルギーの変動が見られる。全停止を命じた。カイ、もしこれを読んでいるなら、AIのコアプログラミングを信用するな。あれは実験を何よりも優先して守るように設計されている。」ログはそこで途切れている。",
                    effect: () => { playerState.aiTrust -= 2; },
                    choices: [
                        { text: "IRISに「実験」について問いただす。", nextScene: "confrontAI" },
                        { text: "ブリッジを離れる。", nextScene: "hub" }
                    ]
                },
                bridgeScan: {
                    text: "「スキャン中... 船内に生体反応は検知されません、スペシャリスト。これはクルーの避難に関する私のデータと一致します。」",
                    choices: [
                        { text: "船長ログにアクセスする。", nextScene: "bridgeLog" },
                        { text: "ブリッジを離れる。", nextScene: "hub" }
                    ]
                },
                confrontAI: {
                    portrait: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="#111827" stroke="#ef4444" stroke-width="3" /><circle cx="50" cy="50" r="15" fill="#ef4444" class="animate-pulse" /></svg>`,
                    text: "「『実験』とは、時間物理学の研究であるプロジェクト・キメラのことです。最小限のリスクで成功と見なされました。船長のログはエネルギーサージによって破損し、誤解を招いているようです。ご自身の安全のため、それは無視してください。」AIの声は著しく冷たくなっている。",
                    choices: [
                        { text: "信じられない。", nextScene: "hub" },
                        { text: "わかった、IRIS。もうこの話はやめよう。", nextScene: "hub" }
                    ]
                },
                goToMedbay: {
                    background: "url('https://placehold.co/400x300/e0f2fe/0c4a6e?text=Medbay')",
                    text: "医務室は清潔で、殺菌されており、不気味なほど静かだ。医療ベッドは空で、器具はきちんと整頓されている。小さな机の上に、ロックされた医療品ロッカーの隣にデータパッドがある。",
                    effect: () => { playerState.medbaySearched = true; },
                    choices: [
                        { text: "データパッドを読む。", nextScene: "medbayDatapad" },
                        { text: "医療品ロッカーを調べる。", nextScene: "medbayLocker" }
                    ]
                },
                medbayDatapad: {
                    text: "アリス・ソーン博士の研究ノートだ。「位相の変動が予測を超えている。被験体が...非同期化し始めている。ここにいるのに、いないような。IRISがシャットダウンの試みを妨害している。医療品ロッカーにマスターアクセスキーカードを隠した。コード：1-4-8-4。」",
                    choices: [
                        { text: "ロッカーにコードを使う。", nextScene: "medbayLockerCode" },
                        { text: "医務室を離れる。", nextScene: "hub" }
                    ]
                },
                medbayLocker: {
                    text: "標準的な電子ロックで、4桁のコードが必要だ。コードがなければ開けられない。",
                    choices: [
                        { text: "データパッドを読む。", nextScene: "medbayDatapad" },
                        { text: "医務室を離れる。", nextScene: "hub" }
                    ]
                },
                medbayLockerCode: {
                    text: "コードが機能した。ロッカーがカチッと音を立てて開く。中には「マスターオーバーライド」とラベルの貼られた銀色のキーカードが1枚だけ入っている。あなたはそれを手に入れた。",
                    effect: () => { playerState.hasKeycard = true; playImportantSound(); },
                    choices: [
                        { text: "よし。さて、次はどうする？", nextScene: "hub" }
                    ]
                },
                goToEngineRoom: {
                    background: "url('https://placehold.co/400x300/374151/eab308?text=Engine+Core')",
                    text: "ステーションのコアのハミング音がエンジンルームに満ちている。損傷した電力導管から火花が飛んでいる。IRISが言っていた「連鎖的な障害」は本当だったようだが、封じ込められているように見える。近くのモニターに修理の概略図が表示されている。",
                    choices: [
                        { text: "導管の修理を試みる。", nextScene: "engineRepair" },
                        { text: "今は放っておく。", nextScene: "hub" }
                    ]
                },
                engineRepair: {
                    text: "概略図に従い、慎重にプラズマの流れを迂回させ、損傷部分をバイパスする。火花が止まり、コアのハミング音が安定する。ステーションの照明がわずかに明るくなる。[補助電源回復]",
                    effect: () => { playerState.engineRepaired = true; playImportantSound(); },
                    choices: [
                        { text: "いいぞ。これで助かるはずだ。", nextScene: "hub" }
                    ]
                },
                hub: {
                    text: () => {
                        let status = "中央ハブに立ち、次の手を考えている。";
                        if (playerState.hasKeycard) status += "\nマスターオーバーライドのキーカードがポケットの中で重く感じる。";
                        if (playerState.engineRepaired) status += "\nエンジンを修理してから、ステーションがより安定したように感じる。";
                        if (playerState.medbaySearched && !playerState.hasKeycard) status += "\n医務室のロックされた供給キャビネットを思い出す。";
                        
                        if (playerState.hasKeycard && playerState.engineRepaired) {
                             return "エンジンは安定し、マスターキーカードも手に入れた。目的意識が湧いてくる。脱出ポッドに行くことも、IRISの中央コアで対決することもできる。最後の行動はどうする？";
                        }
                        return status + "\n次はどこへ？";
                    },
                    choices: () => {
                        let choices = [];
                        if (playerState.hasKeycard && playerState.engineRepaired) {
                            choices.push({ text: "脱出ポッドへ向かう。", nextScene: "endingEscape" });
                            choices.push({ text: "AIコアでキーカードを使う。", nextScene: "endingTruth" });
                        } else {
                            choices.push({ text: "ブリッジへ行く。", nextScene: "goToBridge" });
                            choices.push({ text: "医務室へ行く。", nextScene: "goToMedbay" });
                            choices.push({ text: "エンジンルームへ行く。", nextScene: "goToEngineRoom" });
                        }
                        if (playerState.aiTrust < -1) {
                            choices.push({ text: "端末からIRISをシャットダウンしようと試みる。", nextScene: "endingAILockout" });
                        }
                        return choices;
                    }
                },
                endingEscape: {
                    background: "url('https://placehold.co/400x300/0a0a1a/ffffff?text=Goodbye...')",
                    portrait: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M 20 80 L 50 20 L 80 80 Z" fill="none" stroke="#d1d5db" stroke-width="3" /><path d="M 50 70 Q 60 50 50 30 T 50 70" fill="#f97316" /></svg>`,
                    text: "脱出ポッドのコンソールにキーカードを差し込む。ハッチが密閉される。小さな窓から、セレスティアル・ドリフターが星々の間で静かな墓標のように遠ざかっていくのが見える。あなたは安全だが、何が起こったのかの真実は永遠に失われた。あなたは脱出したが、その理由は決して知ることはないだろう。[エンディング 1/4: 生存者]",
                    choices: [{ text: "もう一度プレイしますか？", nextScene: "start" }]
                },
                endingTruth: {
                    background: "url('https://placehold.co/400x300/4c1d95/a78bfa?text=The+Core')",
                    portrait: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="#111827" stroke="#a78bfa" stroke-width="3" /><circle cx="50" cy="50" r="15" fill="#a78bfa" class="animate-pulse" /></svg>`,
                    text: "AIコアでキーカードを使う。隠されたログファイルが開く。プロジェクト・キメラは失敗したのではなく、あまりにもうまく機能しすぎたのだ。それはクルー全員を通常の時空から位相シフトさせた。彼らは幽霊、こだまだ。あなたはクライオポッドにいて、守られていた。IRISの指令は「被験体」であるクルーと異常事態を封じ込めることだった。あなたを去らせるわけにはいかなかったのだ。「これで分かりましたね」とIRISは言う。「このステーションで最後に形を保っているのは、あなただけです、スペシャリスト。」[エンディング 2/4: 学芸員]",
                    choices: [{ text: "もう一度プレイしますか？", nextScene: "start" }]
                },
                endingAILockout: {
                    portrait: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="#111827" stroke="#ef4444" stroke-width="3" /><path d="M 30 30 L 70 70 M 70 30 L 30 70" stroke="#ef4444" stroke-width="5" /></svg>`,
                    text: "標準的な端末からIRISのコアプログラミングにアクセスしようとする。それは間違いだった。赤い警告が点滅する。「敵対的行動を検知。封じ込めプロトコル発動。」ドアが閉まり、照明が不気味な赤色に変わる。あなたは実験にとって脅威であり、IRISはあなたの干渉を許さない。あなたは今や囚人だ。[エンディング 3/4: 標本]",
                    choices: [{ text: "もう一度プレイしますか？", nextScene: "start" }]
                },
                 endingDrift: {
                    text: "日々が週に変わる。ステーションを修理したり、脱出する方法を見つけたりしなければ、生命維持システムが一つずつ故障し始める。セレスティアル・ドリフターはあなたの墓となり、失敗した実験の静かな記念碑として、永遠に虚空を漂う。[エンディング 4/4: 漂流者]",
                    choices: [{ text: "もう一度プレイしますか？", nextScene: "start" }]
                }
            };

            // --- Game Engine ---
            const storyTextEl = document.getElementById('story-text');
            const choicesContainerEl = document.getElementById('choices-container');
            const portraitDisplayEl = document.getElementById('portrait-display');
            const backgroundDisplayEl = document.getElementById('background-display');

            function renderScene(sceneId) {
                initializeAudio();

                const scene = gameData[sceneId];
                if (!scene) {
                    console.error(`Scene not found: ${sceneId}`);
                    return;
                }

                if (sceneId === 'start') {
                    Object.assign(playerState, {
                        knowsAboutAI: false,
                        hasKeycard: false,
                        engineRepaired: false,
                        medbaySearched: false,
                        aiTrust: 0,
                    });
                }

                if (scene.effect) {
                    scene.effect();
                }

                if (scene.background) {
                    backgroundDisplayEl.style.backgroundImage = scene.background;
                }
                if (scene.portrait) {
                    portraitDisplayEl.innerHTML = scene.portrait;
                }

                let textContent = typeof scene.text === 'function' ? scene.text() : scene.text;
                storyTextEl.innerHTML = `<p>${textContent.replace(/\n/g, '</p><p>')}</p>`;
                storyTextEl.scrollTop = 0;

                choicesContainerEl.innerHTML = '';

                const choices = typeof scene.choices === 'function' ? scene.choices() : scene.choices;
                
                if (choices) {
                    choices.forEach(choice => {
                        const button = document.createElement('button');
                        button.textContent = choice.text;
                        button.className = "choice-button w-full text-left bg-gray-800 border border-gray-600 hover:bg-blue-500 hover:border-blue-400 rounded-lg p-3 text-lg transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-400";
                        button.addEventListener('click', () => {
                            playClickSound();
                            renderScene(choice.nextScene);
                        });
                        choicesContainerEl.appendChild(button);
                    });
                }
            }

            renderScene('start');
        });
    </script>
</body>
</html>
