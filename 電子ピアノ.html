
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ピアノ（手動調律＋一括調律）</title>
  <style>
    body {
      background: #222;
      color: white;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      transform-origin: top center;
      transition: transform 0.3s ease;
      transform: scale(2.25);
    }
    .controls {
      margin: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 15px;
    }
    button, input[type=range], select {
      font-size: 16px;
    }
    .piano {
      display: flex;
      overflow-x: auto;
      padding: 10px;
      background: #111;
      border-top: 2px solid #444;
      border-bottom: 2px solid #444;
      justify-content: center;
      user-select: none;
    }
    .key-container {
      position: relative;
    }
    .white {
      width: 40px;
      height: 200px;
      background: white;
      border: 1px solid #000;
      text-align: center;
      line-height: 200px;
      font-size: 10px;
      cursor: pointer;
      z-index: 1;
      user-select: none;
    }
    .white:active {
      background: #ddd;
    }
    .black {
      width: 25px;
      height: 120px;
      background: black;
      position: absolute;
      top: 0;
      left: 28px;
      z-index: 2;
      cursor: pointer;
      user-select: none;
    }
    .black:active {
      background: #555;
    }
  </style>
</head>
<body>

<!-- ✅ UI表示切り替えチェック -->
<div class="controls">
  <label>
    <input type="checkbox" id="toggleUI" checked>
    ズーム・調律UIを表示
  </label>
</div>

<!-- UI①：ズーム操作 -->
<div class="controls">
  <button id="zoomOutBtn">− 縮小</button>
  <div id="scaleDisplay">225%</div>
  <button id="zoomInBtn">＋ 拡大</button>
</div>

<!-- UI②：調律スライダー -->
<div class="controls">
  <label>全体調律：</label>
  <input type="range" id="tuneSlider" min="-100" max="100" value="-48">
  <span id="tuneValue">-48 Hz</span>
</div>

<div class="piano" id="piano"></div>

<script>
const piano = document.getElementById('piano');
const scaleDisplay = document.getElementById('scaleDisplay');
const zoomInBtn = document.getElementById('zoomInBtn');
const zoomOutBtn = document.getElementById('zoomOutBtn');
const tuneSlider = document.getElementById('tuneSlider');
const tuneValue = document.getElementById('tuneValue');

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

const baseFrequencies = {
  "A0": 27.5, "A#0": 29.135, "B0": 30.868, "C1": 32.703, "C#1": 34.648,
  "D1": 36.708, "D#1": 38.891, "E1": 41.203, "F1": 43.654, "F#1": 46.249,
  "G1": 48.999, "G#1": 51.913, "A1": 55.000, "A#1": 58.270, "B1": 61.735,
  "C2": 65.406, "C#2": 69.296, "D2": 73.416, "D#2": 77.782, "E2": 82.407,
  "F2": 87.307, "F#2": 92.499, "G2": 97.999, "G#2": 103.826, "A2": 110.000,
  "A#2": 116.541, "B2": 123.471, "C3": 130.813, "C#3": 138.591, "D3": 146.832,
  "D#3": 155.563, "E3": 164.814, "F3": 174.614, "F#3": 184.997, "G3": 195.998,
  "G#3": 207.652, "A3": 220.000, "A#3": 233.082, "B3": 246.942, "C4": 261.626,
  "C#4": 277.183, "D4": 293.665, "D#4": 311.127, "E4": 329.628, "F4": 349.228,
  "F#4": 369.994, "G4": 391.995, "G#4": 415.305, "A4": 440.000, "A#4": 466.164,
  "B4": 493.883, "C5": 523.251, "C#5": 554.365, "D5": 587.330, "D#5": 622.254,
  "E5": 659.255, "F5": 698.456, "F#5": 739.989, "G5": 783.991, "G#5": 830.609,
  "A5": 880.000, "A#5": 932.328, "B5": 987.767, "C6": 1046.50, "C#6": 1108.73,
  "D6": 1174.66, "D#6": 1244.51, "E6": 1318.51, "F6": 1396.91, "F#6": 1479.98,
  "G6": 1567.98, "G#6": 1661.22, "A6": 1760.00, "A#6": 1864.66, "B6": 1975.53,
  "C7": 2093.00, "C#7": 2217.46, "D7": 2349.32, "D#7": 2489.02, "E7": 2637.02,
  "F7": 2793.83, "F#7": 2959.96, "G7": 3135.96, "G#7": 3322.44, "A7": 3520.00,
  "A#7": 3729.31, "B7": 3951.07, "C8": 4186.01
};

const keys = Object.keys(baseFrequencies);
let globalTune = -48;
tuneSlider.value = globalTune;
tuneValue.textContent = `${globalTune} Hz`;
tuneValue.style.display = globalTune === 0 ? 'none' : 'inline';

const perKeyOffset = {};
const activeOscillators = new Map();

function getFrequency(note) {
  const base = baseFrequencies[note] || 440;
  const keyOffset = perKeyOffset[note] || 0;
  return base + globalTune + keyOffset;
}

function startNote(note) {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  if (activeOscillators.has(note)) return;
  const freq = getFrequency(note);
  const osc = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
  osc.connect(gainNode);
  gainNode.connect(audioCtx.destination);
  osc.start();
  activeOscillators.set(note, {osc, gainNode});
}

function stopNote(note) {
  const oscObj = activeOscillators.get(note);
  if (!oscObj) return;
  const {osc, gainNode} = oscObj;
  gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
  osc.stop(audioCtx.currentTime + 0.3);
  activeOscillators.delete(note);
}

function createKey(note) {
  const container = document.createElement('div');
  container.className = 'key-container';
  const isBlack = note.includes('#');
  const keyDiv = document.createElement('div');
  keyDiv.className = isBlack ? 'black' : 'white';
  keyDiv.title = note;
  keyDiv.addEventListener('mousedown', e => {
    e.preventDefault();
    startNote(note);
  });
  keyDiv.addEventListener('mouseup', e => {
    e.preventDefault();
    stopNote(note);
  });
  keyDiv.addEventListener('mouseleave', e => {
    e.preventDefault();
    stopNote(note);
  });
  keyDiv.addEventListener('touchstart', e => {
    e.preventDefault();
    startNote(note);
  }, {passive:false});
  keyDiv.addEventListener('touchend', e => {
    e.preventDefault();
    stopNote(note);
  });
  container.appendChild(keyDiv);
  return container;
}

keys.forEach(note => {
  piano.appendChild(createKey(note));
});

let scale = 2.25;
function updateScaleDisplay() {
  scaleDisplay.textContent = `${Math.round(scale * 100)}%`;
}
function changeScale(delta) {
  scale = Math.min(3, Math.max(0.3, scale + delta));
  document.body.style.transform = `scale(${scale})`;
  updateScaleDisplay();
}
updateScaleDisplay();
zoomInBtn.addEventListener('click', () => changeScale(0.05));
zoomOutBtn.addEventListener('click', () => changeScale(-0.05));

// ✅ スライダーで全体調律 & 0Hz 非表示処理
tuneSlider.addEventListener('input', () => {
  globalTune = parseInt(tuneSlider.value);
  tuneValue.textContent = `${globalTune} Hz`;
  tuneValue.style.display = globalTune === 0 ? 'none' : 'inline';
});

// ✅ UI表示切り替え機能
const toggleUI = document.getElementById('toggleUI');
const controlElements = document.querySelectorAll('.controls');
toggleUI.addEventListener('change', () => {
  controlElements.forEach((el, idx) => {
    if (idx > 0) {
      el.style.display = toggleUI.checked ? 'flex' : 'none';
    }
  });
});
</script>

</body>
</html>
