
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ¡ãƒ¢ãƒšãƒ¼ã‚¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <style>
body {
  font-family: sans-serif;
  margin: 0;
  display: flex;
  height: 100vh;
  overflow: hidden;
  background: #fafafa;
}

#sidebar {
  width: 250px;
  background: #eee;
  padding: 1rem;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.memo-scroll {
  flex-grow: 1;
  overflow-y: auto;
  margin-bottom: 1rem;
}

.fixed-buttons {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

#main {
  flex-grow: 1;
  padding: 1rem;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  background: white;
  box-shadow: inset 0 0 10px #ddd;
}

button {
  padding: 0.5rem;
  cursor: pointer;
  border-radius: 5px;
  border: 2px solid black;
  background: white;
  color: black;
  font-size: 1rem;
  transition: background 0.3s;
  box-sizing: border-box;
}

button:hover {
  background: #f0f0f0;
}

#memoList button.selected {
  background: #c8e6c9;
  border-color: #4caf50;
}

input, textarea {
  width: 100%;
  margin-bottom: 1rem;
  font-size: 1rem;
  padding: 0.5rem;
  border-radius: 5px;
  border: 1px solid #ccc;
  box-sizing: border-box;
  font-family: inherit;
}

textarea {
  flex-grow: 1;
  resize: none;
}

#userDisplay {
  margin-bottom: 1rem;
  font-weight: bold;
  text-align: center;
}

#logoutBtn {
  background: #f44336;
  color: white;
  border: none;
}

#logoutBtn:hover {
  background: #d32f2f;
}

/* === ãƒ¡ãƒ¢ä¸€è¦§ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ï¼†ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºçµ±ä¸€ === */
#memoList {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

#memoList button {
  width: 100%;
  height: 3rem;
  font-size: 1rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ã‚¹ãƒãƒ›å¯¾å¿œ */
@media screen and (max-width: 600px) {
  #memoList {
    flex-wrap: nowrap;
    flex-direction: column;
  }
  #memoList button {
    width: 100%;
    height: 3rem;
    font-size: 0.9rem;
  }
}

  </style>
</head>
<body>

<div id="sidebar">
  <div id="userDisplay"></div>

  <input type="text" id="searchInput" placeholder="ãƒ¡ãƒ¢æ¤œç´¢" autocomplete="off" style="margin-bottom: 0.5rem; padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box;" />

  <div class="memo-scroll">
    <div id="memoList"></div>
  </div>

  <div class="fixed-buttons">
    <button id="newMemoBtn">ï¼‹æ–°è¦ãƒ¡ãƒ¢ä½œæˆ</button>
    <button id="deleteBtn">ğŸ—‘ãƒ¡ãƒ¢å‰Šé™¤</button>
    <button id="lockToggleBtn">ğŸ”’ä¿è­·ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
    <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>


<div id="main">
  <input type="text" id="titleInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" autocomplete="off" />
  <textarea id="contentInput" placeholder="ãƒ¡ãƒ¢å†…å®¹"></textarea>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const accountId = params.get('accountId');

  if (!accountId) {
    alert('ä¸æ­£ãªã‚¢ã‚¯ã‚»ã‚¹ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚Šã¾ã™ã€‚');
    window.location.href = 'index.html';
  }

  const userKey = 'user_' + accountId;
  let currentUser = null;
  let memos = [];
  let currentMemoIndex = -1;
  let protectionPassword = null;

  const userDisplay = document.getElementById('userDisplay');
  const memoList = document.getElementById('memoList');
  const newMemoBtn = document.getElementById('newMemoBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const lockToggleBtn = document.getElementById('lockToggleBtn');
  const titleInput = document.getElementById('titleInput');
  const contentInput = document.getElementById('contentInput');
  const searchInput = document.getElementById('searchInput');

  function loadUser() {
    const data = localStorage.getItem(userKey);
    if (!data) {
      alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
      window.location.href = 'index.html';
      return;
    }
    currentUser = JSON.parse(data);
    memos = currentUser.memos || [];
    currentMemoIndex = memos.length > 0 ? 0 : -1;
    protectionPassword = currentUser.protectionPassword || null;
    userDisplay.textContent = `ã‚ˆã†ã“ãã€${currentUser.name}ã•ã‚“ï¼ˆID:${accountId}ï¼‰`;
    renderMemoList();
    if (currentMemoIndex >= 0) loadMemo(currentMemoIndex);
    else clearMemoInputs();
  }

  function saveUserData() {
    if (!currentUser) return;
    currentUser.memos = memos;
    currentUser.protectionPassword = protectionPassword;
    localStorage.setItem(userKey, JSON.stringify(currentUser));
  }

  function renderMemoList(filter = '') {
    memoList.innerHTML = '';
    memos.forEach((memo, idx) => {
      if (!memo.title.toLowerCase().includes(filter.toLowerCase()) && !memo.content.toLowerCase().includes(filter.toLowerCase())) {
        return; // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«åˆã‚ãªã„ãƒ¡ãƒ¢ã¯è¡¨ç¤ºã—ãªã„
      }
      const btn = document.createElement('button');
      btn.textContent = memo.title || 'ï¼ˆç„¡é¡Œï¼‰';
      btn.className = idx === currentMemoIndex ? 'selected' : '';
      if (memo.protected) btn.textContent = 'ğŸ”’ ' + btn.textContent;
      btn.addEventListener('click', () => {
        saveCurrentMemo();
        currentMemoIndex = idx;
        loadMemo(idx);
        renderMemoList(searchInput.value);
      });
      memoList.appendChild(btn);
    });
  }

  function loadMemo(index) {
    if (index < 0 || index >= memos.length) {
      clearMemoInputs();
      return;
    }
    const memo = memos[index];
    if (memo.protected) {
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
      const inputPw = prompt('ã“ã®ãƒ¡ãƒ¢ã¯ä¿è­·ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      if (inputPw !== protectionPassword) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚ãƒ¡ãƒ¢ã‚’é–‹ã‘ã¾ã›ã‚“ã€‚');
        return;
      }
    }
    titleInput.value = memo.title;
    contentInput.value = memo.content;
  }

  function clearMemoInputs() {
    titleInput.value = '';
    contentInput.value = '';
  }

  function saveCurrentMemo() {
    if (currentMemoIndex < 0) return;
    memos[currentMemoIndex].title = titleInput.value;
    memos[currentMemoIndex].content = contentInput.value;
    saveUserData();
  }

  newMemoBtn.addEventListener('click', () => {
    saveCurrentMemo();
    memos.push({ title: '', content: '', protected: false });
    currentMemoIndex = memos.length - 1;
    renderMemoList(searchInput.value);
    loadMemo(currentMemoIndex);
  });

  deleteBtn.addEventListener('click', () => {
    if (currentMemoIndex < 0) return;
    if (memos[currentMemoIndex].protected) {
      alert('ä¿è­·ä¸­ã®ãƒ¡ãƒ¢ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ï¼');
      return;
    }
    if (!confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    memos.splice(currentMemoIndex, 1);
    if (memos.length === 0) {
      currentMemoIndex = -1;
      clearMemoInputs();
    } else {
      currentMemoIndex = Math.min(currentMemoIndex, memos.length - 1);
      loadMemo(currentMemoIndex);
    }
    renderMemoList(searchInput.value);
    saveUserData();
  });

  logoutBtn.addEventListener('click', () => {
    saveCurrentMemo();
    window.location.href = 'index.html';
  });

  lockToggleBtn.addEventListener('click', () => {
    if (currentMemoIndex < 0) return;
    if (!protectionPassword) {
      const pw = prompt('ä¿è­·ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
      if (!pw) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ä¿è­·ãƒ¢ãƒ¼ãƒ‰ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚');
        return;
      }
      protectionPassword = pw;
    }
    memos[currentMemoIndex].protected = !memos[currentMemoIndex].protected;
    alert(memos[currentMemoIndex].protected ? 'ã“ã®ãƒ¡ãƒ¢ã¯ä¿è­·ã•ã‚Œã¾ã—ãŸã€‚' : 'ä¿è­·ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
    renderMemoList(searchInput.value);
    saveUserData();
  });

  searchInput.addEventListener('input', () => {
    renderMemoList(searchInput.value);
  });

  window.addEventListener('beforeunload', saveCurrentMemo);

  loadUser();



  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('âœ… Service Worker registered'))
      .catch(err => console.error('âŒ SW registration failed:', err));
  }


</script>


</body>
</html>
