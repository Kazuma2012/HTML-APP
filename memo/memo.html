
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>メモページ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <style>
body {
  font-family: sans-serif;
  margin: 0;
  display: flex;
  height: 100vh;
  overflow: hidden;
  background: #fafafa;
}

#sidebar {
  width: 250px;
  background: #eee;
  padding: 1rem;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.memo-scroll {
  flex-grow: 1;
  overflow-y: auto;
  margin-bottom: 1rem;
}

.fixed-buttons {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

#main {
  flex-grow: 1;
  padding: 1rem;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  background: white;
  box-shadow: inset 0 0 10px #ddd;
}

button {
  padding: 0.5rem;
  cursor: pointer;
  border-radius: 5px;
  border: 2px solid black;
  background: white;
  color: black;
  font-size: 1rem;
  transition: background 0.3s;
  box-sizing: border-box;
}

button:hover {
  background: #f0f0f0;
}

#memoList button.selected {
  background: #c8e6c9;
  border-color: #4caf50;
}

input, textarea {
  width: 100%;
  margin-bottom: 1rem;
  font-size: 1rem;
  padding: 0.5rem;
  border-radius: 5px;
  border: 1px solid #ccc;
  box-sizing: border-box;
  font-family: inherit;
}

textarea {
  flex-grow: 1;
  resize: none;
}

#userDisplay {
  margin-bottom: 1rem;
  font-weight: bold;
  text-align: center;
}

#logoutBtn {
  background: #f44336;
  color: white;
  border: none;
}

#logoutBtn:hover {
  background: #d32f2f;
}

/* === メモ一覧を縦に並べる＆ボタンサイズ統一 === */
#memoList {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

#memoList button {
  width: 100%;
  height: 3rem;
  font-size: 1rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* スマホ対応 */
@media screen and (max-width: 600px) {
  #memoList {
    flex-wrap: nowrap;
    flex-direction: column;
  }
  #memoList button {
    width: 100%;
    height: 3rem;
    font-size: 0.9rem;
  }
}

  </style>
</head>
<body>

<div id="sidebar">
  <div id="userDisplay"></div>

  <input type="text" id="searchInput" placeholder="メモ検索" autocomplete="off" style="margin-bottom: 0.5rem; padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box;" />

  <div class="memo-scroll">
    <div id="memoList"></div>
  </div>

  <div class="fixed-buttons">
    <button id="newMemoBtn">＋新規メモ作成</button>
    <button id="deleteBtn">🗑メモ削除</button>
    <button id="lockToggleBtn">🔒保護モード切替</button>
    <button id="logoutBtn">ログアウト</button>
  </div>
</div>


<div id="main">
  <input type="text" id="titleInput" placeholder="タイトル" autocomplete="off" />
  <textarea id="contentInput" placeholder="メモ内容"></textarea>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const accountId = params.get('accountId');

  if (!accountId) {
    alert('不正なアクセスです。ログインページへ戻ります。');
    window.location.href = 'index.html';
  }

  const userKey = 'user_' + accountId;
  let currentUser = null;
  let memos = [];
  let currentMemoIndex = -1;
  let protectionPassword = null;

  const userDisplay = document.getElementById('userDisplay');
  const memoList = document.getElementById('memoList');
  const newMemoBtn = document.getElementById('newMemoBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const lockToggleBtn = document.getElementById('lockToggleBtn');
  const titleInput = document.getElementById('titleInput');
  const contentInput = document.getElementById('contentInput');
  const searchInput = document.getElementById('searchInput');

  function loadUser() {
    const data = localStorage.getItem(userKey);
    if (!data) {
      alert('ユーザーデータが見つかりません。ログイン画面に戻ります。');
      window.location.href = 'index.html';
      return;
    }
    currentUser = JSON.parse(data);
    memos = currentUser.memos || [];
    currentMemoIndex = memos.length > 0 ? 0 : -1;
    protectionPassword = currentUser.protectionPassword || null;
    userDisplay.textContent = `ようこそ、${currentUser.name}さん（ID:${accountId}）`;
    renderMemoList();
    if (currentMemoIndex >= 0) loadMemo(currentMemoIndex);
    else clearMemoInputs();
  }

  function saveUserData() {
    if (!currentUser) return;
    currentUser.memos = memos;
    currentUser.protectionPassword = protectionPassword;
    localStorage.setItem(userKey, JSON.stringify(currentUser));
  }

  function renderMemoList(filter = '') {
    memoList.innerHTML = '';
    memos.forEach((memo, idx) => {
      if (!memo.title.toLowerCase().includes(filter.toLowerCase()) && !memo.content.toLowerCase().includes(filter.toLowerCase())) {
        return; // フィルターに合わないメモは表示しない
      }
      const btn = document.createElement('button');
      btn.textContent = memo.title || '（無題）';
      btn.className = idx === currentMemoIndex ? 'selected' : '';
      if (memo.protected) btn.textContent = '🔒 ' + btn.textContent;
      btn.addEventListener('click', () => {
        saveCurrentMemo();
        currentMemoIndex = idx;
        loadMemo(idx);
        renderMemoList(searchInput.value);
      });
      memoList.appendChild(btn);
    });
  }

  function loadMemo(index) {
    if (index < 0 || index >= memos.length) {
      clearMemoInputs();
      return;
    }
    const memo = memos[index];
    if (memo.protected) {
      // パスワード確認
      const inputPw = prompt('このメモは保護されています。パスワードを入力してください。');
      if (inputPw !== protectionPassword) {
        alert('パスワードが違います。メモを開けません。');
        return;
      }
    }
    titleInput.value = memo.title;
    contentInput.value = memo.content;
  }

  function clearMemoInputs() {
    titleInput.value = '';
    contentInput.value = '';
  }

  function saveCurrentMemo() {
    if (currentMemoIndex < 0) return;
    memos[currentMemoIndex].title = titleInput.value;
    memos[currentMemoIndex].content = contentInput.value;
    saveUserData();
  }

  newMemoBtn.addEventListener('click', () => {
    saveCurrentMemo();
    memos.push({ title: '', content: '', protected: false });
    currentMemoIndex = memos.length - 1;
    renderMemoList(searchInput.value);
    loadMemo(currentMemoIndex);
  });

  deleteBtn.addEventListener('click', () => {
    if (currentMemoIndex < 0) return;
    if (memos[currentMemoIndex].protected) {
      alert('保護中のメモは削除できません！');
      return;
    }
    if (!confirm('このメモを削除してもよろしいですか？')) return;
    memos.splice(currentMemoIndex, 1);
    if (memos.length === 0) {
      currentMemoIndex = -1;
      clearMemoInputs();
    } else {
      currentMemoIndex = Math.min(currentMemoIndex, memos.length - 1);
      loadMemo(currentMemoIndex);
    }
    renderMemoList(searchInput.value);
    saveUserData();
  });

  logoutBtn.addEventListener('click', () => {
    saveCurrentMemo();
    window.location.href = 'index.html';
  });

  lockToggleBtn.addEventListener('click', () => {
    if (currentMemoIndex < 0) return;
    if (!protectionPassword) {
      const pw = prompt('保護モード用のパスワードを設定してください。');
      if (!pw) {
        alert('パスワードが設定されませんでした。保護モードは使用できません。');
        return;
      }
      protectionPassword = pw;
    }
    memos[currentMemoIndex].protected = !memos[currentMemoIndex].protected;
    alert(memos[currentMemoIndex].protected ? 'このメモは保護されました。' : '保護モードを解除しました。');
    renderMemoList(searchInput.value);
    saveUserData();
  });

  searchInput.addEventListener('input', () => {
    renderMemoList(searchInput.value);
  });

  window.addEventListener('beforeunload', saveCurrentMemo);

  loadUser();



  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('✅ Service Worker registered'))
      .catch(err => console.error('❌ SW registration failed:', err));
  }


</script>


</body>
</html>
