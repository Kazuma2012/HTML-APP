<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dæ¢åµæ¨ç†ã‚²ãƒ¼ãƒ ï¼šå°ã•ãªç”ºã®æ®ºäººäº‹ä»¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Serif JP', serif;
            margin: 0;
            overflow: hidden; /* CanvasãŒèƒŒæ™¯ã«ãªã‚‹ã‚ˆã†ã« */
        }
        #game-ui {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }
        #renderer-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-slate-900 text-white">

    <!-- 3D Canvas -->
    <div id="renderer-container"></div>

    <!-- Game UI -->
    <div id="game-ui" class="w-full">
        <div class="max-w-3xl mx-auto bg-slate-900/80 backdrop-blur-sm rounded-t-2xl shadow-2xl overflow-hidden border-t-4 border-x-4 border-slate-700">
            <!-- è¨¼æ‹ å“ãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ -->
            <div id="inventory-container" class="bg-slate-950/80 p-3 border-b-4 border-slate-700">
                <h3 class="font-bold text-amber-400 mb-2 text-center text-sm tracking-widest">å…¥æ‰‹ã—ãŸè¨¼æ‹ </h3>
                <ul id="inventory-list" class="flex flex-wrap gap-x-4 gap-y-2 justify-center items-center text-slate-300">
                    <li id="no-evidence">ã¾ã è¨¼æ‹ ã¯ãªã„...</li>
                </ul>
            </div>
            <div class="p-6 md:p-8">
                <!-- ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="text-container" class="mb-6 min-h-[100px] text-lg leading-relaxed">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
                <!-- é¸æŠè‚¢ã‚¨ãƒªã‚¢ -->
                <div id="choices-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- é¸æŠè‚¢ãƒœã‚¿ãƒ³ -->
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- DOM Elements ---
        const textContainer = document.getElementById('text-container');
        const choicesContainer = document.getElementById('choices-container');
        const inventoryList = document.getElementById('inventory-list');
        const noEvidence = document.getElementById('no-evidence');
        const rendererContainer = document.getElementById('renderer-container');

        let inventory = new Set();

        // --- 3D Setup ---
        let scene, camera, renderer, controls;
        let currentSceneObjects = [];

        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1e293b); // slate-800

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            rendererContainer.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.minDistance = 2;
            controls.maxDistance = 20;
            controls.target.set(0, 1, 0);

            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);

            window.addEventListener('resize', onWindowResize, false);
            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function clearScene() {
            currentSceneObjects.forEach(obj => scene.remove(obj));
            currentSceneObjects = [];
        }

        // --- Scene Builders ---
        function buildCrimeScene() {
            clearScene();
            // Room
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(20, 20), new THREE.MeshStandardMaterial({ color: 0x475569 }));
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
            currentSceneObjects.push(floor);

            // Desk
            const desk = new THREE.Mesh(new THREE.BoxGeometry(4, 1.5, 2), new THREE.MeshStandardMaterial({ color: 0x5a3a22 }));
            desk.position.set(0, 0.75, -5);
            desk.castShadow = true;
            scene.add(desk);
            currentSceneObjects.push(desk);

            // Evidence markers
            const letterGeo = new THREE.PlaneGeometry(0.5, 0.7);
            const letterMat = new THREE.MeshBasicMaterial({ color: 0xffff00, side: THREE.DoubleSide });
            const letter = new THREE.Mesh(letterGeo, letterMat);
            letter.position.set(0.5, 1.55, -5);
            scene.add(letter);
            currentSceneObjects.push(letter);

            const knifeGeo = new THREE.CylinderGeometry(0.1, 0.1, 0.8);
            const knifeMat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            const knife = new THREE.Mesh(knifeGeo, knifeMat);
            knife.position.set(-3, 0.1, -2);
            knife.rotation.z = Math.PI / 2;
            scene.add(knife);
            currentSceneObjects.push(knife);
            
            // Spotlight
            const spotLight = new THREE.SpotLight(0xffffff, 5, 30, Math.PI * 0.2, 0.5);
            spotLight.position.set(0, 15, 0);
            spotLight.castShadow = true;
            scene.add(spotLight);
            currentSceneObjects.push(spotLight);

            camera.position.set(0, 6, 8);
            controls.target.set(0, 1, -2);
        }

        function buildInterrogationRoom(suspectType) {
            clearScene();
            // Room
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(15, 15), new THREE.MeshStandardMaterial({ color: 0x334155 }));
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
            currentSceneObjects.push(floor);

            // Table
            const table = new THREE.Mesh(new THREE.BoxGeometry(3, 1.2, 1.5), new THREE.MeshStandardMaterial({ color: 0x64748b }));
            table.position.set(0, 0.6, 0);
            table.castShadow = true;
            scene.add(table);
            currentSceneObjects.push(table);

            // Suspect Figure
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshStandardMaterial({ color: suspectType === 'tanaka' ? 0x94a3b8 : 0xa1a1aa }));
            head.position.set(0, 2.4, -2);
            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.3, 1.5), new THREE.MeshStandardMaterial({ color: suspectType === 'tanaka' ? 0x475569 : 0x52525b }));
            body.position.set(0, 1.45, -2);
            const suspect = new THREE.Group();
            suspect.add(head);
            suspect.add(body);
            suspect.castShadow = true;
            scene.add(suspect);
            currentSceneObjects.push(suspect);

            // Light
            const light = new THREE.PointLight(0xffffff, 10, 10);
            light.position.set(0, 5, 0);
            light.castShadow = true;
            scene.add(light);
            currentSceneObjects.push(light);

            camera.position.set(0, 3, 5);
            controls.target.set(0, 1.5, 0);
        }
        
        function buildEndingScene(isSuccess) {
            clearScene();
            const color = isSuccess ? 0x15803d : 0xbe123c;
            const light = new THREE.SpotLight(color, 20, 30, Math.PI * 0.3, 1);
            light.position.set(0, 10, 0);
            scene.add(light);
            currentSceneObjects.push(light);
            
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(20, 20), new THREE.MeshStandardMaterial({ color: 0x0f172a }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);
            currentSceneObjects.push(floor);
        }

        // --- Game Logic ---
        const story = {
            start: {
                text: "é™ã‹ãªæ¸¯ç”ºã§ã€è³‡ç”£å®¶ã®å±±ä¸‹æ°ãŒæ®ºå®³ã•ã‚ŒãŸã€‚ã‚ãªãŸã¯æ‹…å½“åˆ‘äº‹ã¨ã—ã¦ã€ã“ã®äº‹ä»¶ã®æœæŸ»ã‚’å‘½ã˜ã‚‰ã‚ŒãŸã€‚ã¾ãšã¯ã©ã“ã‹ã‚‰èª¿ã¹ã‚‹ï¼Ÿ",
                sceneBuilder: buildCrimeScene,
                choices: [
                    { text: "äº‹ä»¶ç¾å ´ã‚’è©³ã—ãèª¿ã¹ã‚‹", next: "scene_examine" },
                    { text: "é–¢ä¿‚è€…ã¸ã®èãè¾¼ã¿ã‚’é–‹å§‹ã™ã‚‹", next: "scene_interrogate_start" }
                ]
            },
            scene_examine: {
                text: "ç¾å ´ã¯å±±ä¸‹æ°ã®æ›¸æ–ã ã€‚è’ã‚‰ã•ã‚ŒãŸæ§˜å­ã¯ãªã„ãŒã€åºŠã«è¡€ç—•ã¨å€’ã‚ŒãŸãƒ©ãƒ³ãƒ—ãŒã‚ã‚‹ã€‚æœºã®ä¸Šã«ã¯ä½•ã‹æ‰‹ç´™ã®ã‚ˆã†ãªã‚‚ã®ãŒè¦‹ãˆã‚‹ã€‚",
                sceneBuilder: buildCrimeScene,
                choices: [
                    { text: "åºŠã®è¡€ç—•ã‚’èª¿ã¹ã‚‹", next: "scene_examine_blood" },
                    { text: "æœºã®æ‰‹ç´™ã‚’èª¿ã¹ã‚‹", next: "scene_examine_letter" }
                ]
            },
            scene_examine_blood: {
                text: "è¡€ç—•ã®ãã°ã«ã€å°ã•ãªãƒ•ãƒ«ãƒ¼ãƒ„ãƒŠã‚¤ãƒ•ãŒè½ã¡ã¦ã„ã‚‹ã€‚æŸ„ã«ã¯æ‹­ãå–ã‚‰ã‚ŒãŸã‚ˆã†ãªè·¡ãŒã‚ã‚‹ãŒã€å¾®ã‹ã«è¡€ãŒä»˜ç€ã—ã¦ã„ã‚‹ã‚ˆã†ã ã€‚é‡è¦ãªè¨¼æ‹ ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚",
                onEnter: () => addInventory("è¡€ã®ä»˜ã„ãŸãƒŠã‚¤ãƒ•"),
                sceneBuilder: buildCrimeScene,
                choices: [
                    { text: "æœºã®æ‰‹ç´™ã‚‚èª¿ã¹ã‚‹", next: "scene_examine_letter" },
                    { text: "ç¾å ´ã®èª¿æŸ»ã‚’çµ‚ãˆã‚‹", next: "scene_interrogate_start" }
                ]
            },
            scene_examine_letter: {
                text: "æœºã®ä¸Šã«ã¯ã€äº‹æ¥­ã®å¤±æ•—ã‚’ãªã˜ã‚‹è„…è¿«çŠ¶ãŒç½®ã‹ã‚Œã¦ã„ãŸã€‚ã€ãŠå‰ã®ã›ã„ã§å…¨ã¦ã‚’å¤±ã£ãŸã€‚å¿…ãšå ±ã„ã‚’å—ã‘ã•ã›ã‚‹ã€ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹ã€‚å·®å‡ºäººã®åå‰ã¯ãªã„ã€‚",
                onEnter: () => addInventory("è„…è¿«çŠ¶"),
                sceneBuilder: buildCrimeScene,
                choices: [
                    { text: "åºŠã®è¡€ç—•ã‚‚èª¿ã¹ã‚‹", next: "scene_examine_blood" },
                    { text: "ç¾å ´ã®èª¿æŸ»ã‚’çµ‚ãˆã‚‹", next: "scene_interrogate_start" }
                ]
            },
            scene_interrogate_start: {
                text: "æœæŸ»ç·šä¸Šã«2äººã®å®¹ç–‘è€…ãŒæµ®ã‹ã³ä¸ŠãŒã£ãŸã€‚è¢«å®³è€…ã®ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã§ã‚ã‚‹ç”°ä¸­ã¨ã€è¢«å®³è€…ã«è§£é›‡ã•ã‚ŒãŸå…ƒç§˜æ›¸ã®éˆ´æœ¨ã ã€‚ã©ã¡ã‚‰ã‹ã‚‰è©±ã‚’èãï¼Ÿ",
                sceneBuilder: () => buildInterrogationRoom(),
                choices: [
                    { text: "ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ç”°ä¸­ã‚’å°‹å•ã™ã‚‹", next: "interrogate_tanaka_1" },
                    { text: "å…ƒç§˜æ›¸ã®éˆ´æœ¨ã‚’å°‹å•ã™ã‚‹", next: "interrogate_suzuki_1" }
                ]
            },
            interrogate_tanaka_1: {
                text: "ç”°ä¸­ã¯è½ã¡ç€ã„ãŸæ§˜å­ã§å°‹å•ã«å¿œã˜ãŸã€‚ã€Œå±±ä¸‹ã•ã‚“ã¨ã¯é•·å¹´ã®ä»˜ãåˆã„ã§ã—ãŸã€‚äº‹æ¥­ã¯é †èª¿ã§ã—ãŸã—ã€æ®ºã™å‹•æ©Ÿãªã‚“ã¦ã‚ã‚Šã¾ã›ã‚“ã‚ˆã€ã¨å½¼ã¯è¨€ã†ã€‚",
                sceneBuilder: () => buildInterrogationRoom('tanaka'),
                choices: [
                    { text: "ï¼ˆè„…è¿«çŠ¶ã‚’æŒã£ã¦ã„ã‚‹å ´åˆï¼‰ã“ã®æ‰‹ç´™ã«è¦‹è¦šãˆã¯ï¼Ÿ", next: "interrogate_tanaka_2", condition: () => inventory.has("è„…è¿«çŠ¶") },
                    { text: "äº‹ä»¶å½“å¤œã®ã‚¢ãƒªãƒã‚¤ã‚’èã", next: "interrogate_tanaka_3" },
                    { text: "éˆ´æœ¨ã«ã¤ã„ã¦å°‹ã­ã‚‹", next: "interrogate_tanaka_4" },
                    { text: "å°‹å•ã‚’çµ‚ãˆã‚‹", next: "scene_interrogate_start_after_tanaka" }
                ]
            },
            interrogate_tanaka_2: {
                text: "è„…è¿«çŠ¶ã‚’è¦‹ã›ã‚‹ã¨ã€ç”°ä¸­ã¯é¡”ã‚’ã—ã‹ã‚ãŸã€‚ã€Œã“ã‚Œã¯...ã²ã©ã„ã€‚ã§ã™ãŒã€ç§ã®ç­†è·¡ã§ã¯ãªã„ã€‚ãŠãã‚‰ãã€å½¼ã«æ¨ã¿ã‚’æŒã¤èª°ã‹ã®ä»•æ¥­ã§ã—ã‚‡ã†ã€‚ä¾‹ãˆã°ã€è§£é›‡ã•ã‚ŒãŸéˆ´æœ¨ã•ã‚“ã¨ã‹...ã€",
                onEnter: () => addInventory("ç”°ä¸­ã¯éˆ´æœ¨ã‚’ç–‘ã£ã¦ã„ã‚‹"),
                sceneBuilder: () => buildInterrogationRoom('tanaka'),
                choices: [
                    { text: "äº‹ä»¶å½“å¤œã®ã‚¢ãƒªãƒã‚¤ã‚’èã", next: "interrogate_tanaka_3" },
                    { text: "å°‹å•ã‚’çµ‚ãˆã‚‹", next: "scene_interrogate_start_after_tanaka" }
                ]
            },
            interrogate_tanaka_3: {
                text: "ã€Œäº‹ä»¶ãŒã‚ã£ãŸã¨ã•ã‚Œã‚‹å¤œã¯ã€ãšã£ã¨è‡ªå®…ã§ä»•äº‹ã‚’ã—ã¦ã„ã¾ã—ãŸã€‚ä¸€äººã ã£ãŸã®ã§è¨¼æ˜ã¯ã§ãã¾ã›ã‚“ãŒã€ã¨ç”°ä¸­ã¯ç­”ãˆãŸã€‚å®Œç’§ãªã‚¢ãƒªãƒã‚¤ã¯ãªã„ã‚ˆã†ã ã€‚",
                onEnter: () => addInventory("ç”°ä¸­ã®ã‚¢ãƒªãƒã‚¤ã¯ä¸ç¢ºã‹"),
                sceneBuilder: () => buildInterrogationRoom('tanaka'),
                choices: [
                    { text: "éˆ´æœ¨ã«ã¤ã„ã¦å°‹ã­ã‚‹", next: "interrogate_tanaka_4" },
                    { text: "å°‹å•ã‚’çµ‚ãˆã‚‹", next: "scene_interrogate_start_after_tanaka" }
                ]
            },
            interrogate_tanaka_4: {
                text: "ã€Œéˆ´æœ¨ã•ã‚“ã¯å„ªç§€ã§ã—ãŸãŒã€ä¼šç¤¾ã®é‡‘ã‚’ä½¿ã„è¾¼ã‚“ã§ã„ã‚‹ç–‘æƒ‘ãŒã‚ã‚Šã€å±±ä¸‹ã•ã‚“ãŒè§£é›‡ã—ãŸã‚“ã§ã™ã€‚å½¼å¥³ã¯ç›¸å½“æ¨ã‚“ã§ã„ãŸã¯ãšã§ã™ã‚ˆã€",
                sceneBuilder: () => buildInterrogationRoom('tanaka'),
                choices: [
                    { text: "å°‹å•ã‚’çµ‚ãˆã‚‹", next: "scene_interrogate_start_after_tanaka" }
                ]
            },
            scene_interrogate_start_after_tanaka: {
                text: "ç”°ä¸­ã®å°‹å•ã‚’çµ‚ãˆãŸã€‚æ¬¡ã¯ã©ã†ã™ã‚‹ï¼Ÿ",
                sceneBuilder: () => buildInterrogationRoom(),
                choices: [
                    { text: "å…ƒç§˜æ›¸ã®éˆ´æœ¨ã‚’å°‹å•ã™ã‚‹", next: "interrogate_suzuki_1" },
                    { text: "ï¼ˆè¨¼æ‹ ãŒæƒã£ã¦ã„ã‚‹å ´åˆï¼‰çŠ¯äººã‚’å‘Šç™ºã™ã‚‹", next: "final_accusation", condition: () => inventory.size >= 2 }
                ]
            },
            interrogate_suzuki_1: {
                text: "éˆ´æœ¨ã¯ç¥çµŒè³ªãã†ã«ç›®ã‚’æ³³ãŒã›ã¦ã„ã‚‹ã€‚ã€Œå±±ä¸‹ã•ã‚“ã«ã¯ãŠä¸–è©±ã«ãªã‚Šã¾ã—ãŸãŒã€ä¸å½“ã«è§£é›‡ã•ã‚ŒãŸã‚“ã§ã™ï¼ã§ã‚‚ã€æ®ºã—ãŸã‚Šãªã‚“ã¦ã—ã¦ã„ã¾ã›ã‚“ï¼ã€",
                sceneBuilder: () => buildInterrogationRoom('suzuki'),
                choices: [
                    { text: "ï¼ˆè¡€ã®ä»˜ã„ãŸãƒŠã‚¤ãƒ•ã‚’æŒã£ã¦ã„ã‚‹å ´åˆï¼‰ã“ã®ãƒŠã‚¤ãƒ•ã«è¦‹è¦šãˆã¯ï¼Ÿ", next: "interrogate_suzuki_2", condition: () => inventory.has("è¡€ã®ä»˜ã„ãŸãƒŠã‚¤ãƒ•") },
                    { text: "è§£é›‡ã•ã‚ŒãŸç†ç”±ã‚’èã", next: "interrogate_suzuki_3" },
                    { text: "ç”°ä¸­ã«ã¤ã„ã¦å°‹ã­ã‚‹", next: "interrogate_suzuki_4" },
                    { text: "å°‹å•ã‚’çµ‚ãˆã‚‹", next: "scene_interrogate_start_after_suzuki" }
                ]
            },
            interrogate_suzuki_2: {
                text: "ãƒŠã‚¤ãƒ•ã‚’è¦‹ã›ã‚‹ã¨ã€éˆ´æœ¨ã¯æ¯ã‚’å‘‘ã‚“ã ã€‚ã€Œãã€ãã‚Œã¯...ç§ãŒä¼šç¤¾ã®çµ¦æ¹¯å®¤ã§ä½¿ã£ã¦ã„ãŸã‚‚ã®ã§ã™...ã§ã‚‚ã€ãªãœã“ã“ã«...ï¼Ÿã€å½¼å¥³ã¯æ˜ã‚‰ã‹ã«å‹•æºã—ã¦ã„ã‚‹ã€‚",
                onEnter: () => addInventory("ãƒŠã‚¤ãƒ•ã¯éˆ´æœ¨ã®ã‚‚ã®"),
                sceneBuilder: () => buildInterrogationRoom('suzuki'),
                choices: [
                    { text: "è§£é›‡ã•ã‚ŒãŸç†ç”±ã‚’èã", next: "interrogate_suzuki_3" },
                    { text: "å°‹å•ã‚’çµ‚ãˆã‚‹", next: "scene_interrogate_start_after_suzuki" }
                ]
            },
            interrogate_suzuki_3: {
                text: "ã€Œæ¨ªé ˜ãªã‚“ã¦ã—ã¦ã„ã¾ã›ã‚“ï¼ã‚ã‚Œã¯ç”°ä¸­ã•ã‚“ãŒä»•çµ„ã‚“ã ç½ ã§ã™ï¼å½¼ãŒä¼šç¤¾ã®é‡‘ã‚’å‹•ã‹ã—ã¦ã€ç§ã«ç½ªã‚’ãªã™ã‚Šã¤ã‘ãŸã‚“ã§ã™ï¼ã€ã¨éˆ´æœ¨ã¯æ¶™ãªãŒã‚‰ã«è¨´ãˆãŸã€‚",
                onEnter: () => addInventory("éˆ´æœ¨ã¯ç”°ä¸­ãŒçŠ¯äººã ã¨ä¸»å¼µ"),
                sceneBuilder: () => buildInterrogationRoom('suzuki'),
                choices: [
                    { text: "ç”°ä¸­ã«ã¤ã„ã¦å°‹ã­ã‚‹", next: "interrogate_suzuki_4" },
                    { text: "å°‹å•ã‚’çµ‚ãˆã‚‹", next: "scene_interrogate_start_after_suzuki" }
                ]
            },
            interrogate_suzuki_4: {
                text: "ã€Œç”°ä¸­ã•ã‚“ã¯å±±ä¸‹ã•ã‚“ã®äº‹æ¥­ã‚’ä¹—ã£å–ã‚ã†ã¨ã—ã¦ã„ã¾ã—ãŸã€‚å±±ä¸‹ã•ã‚“ã‚‚æœ€è¿‘ãã‚Œã«æ°—ã¥ã„ã¦ã€å½¼ã‚’è­¦æˆ’ã—ã¦ã„ãŸã‚“ã§ã™ã€",
                sceneBuilder: () => buildInterrogationRoom('suzuki'),
                choices: [
                    { text: "å°‹å•ã‚’çµ‚ãˆã‚‹", next: "scene_interrogate_start_after_suzuki" }
                ]
            },
            scene_interrogate_start_after_suzuki: {
                text: "éˆ´æœ¨ã®å°‹å•ã‚’çµ‚ãˆãŸã€‚æ¬¡ã¯ã©ã†ã™ã‚‹ï¼Ÿ",
                sceneBuilder: () => buildInterrogationRoom(),
                choices: [
                    { text: "ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ç”°ä¸­ã‚’å°‹å•ã™ã‚‹", next: "interrogate_tanaka_1" },
                    { text: "ï¼ˆè¨¼æ‹ ãŒæƒã£ã¦ã„ã‚‹å ´åˆï¼‰çŠ¯äººã‚’å‘Šç™ºã™ã‚‹", next: "final_accusation", condition: () => inventory.size >= 3 }
                ]
            },
            final_accusation: {
                text: "å…¨ã¦ã®èª¿æŸ»ãŒçµ‚ã‚ã£ãŸã€‚å›ãŒé›†ã‚ãŸè¨¼æ‹ ã¨è¨¼è¨€ã‹ã‚‰ã€çŠ¯äººã¯ç‰¹å®šã§ããŸã‹ï¼Ÿã•ã‚ã€å‘Šç™ºã®æ™‚ã ã€‚",
                sceneBuilder: () => buildInterrogationRoom(),
                choices: [
                    { text: "çŠ¯äººã¯ç”°ä¸­ã ï¼", next: "ending_tanaka" },
                    { text: "çŠ¯äººã¯éˆ´æœ¨ã ï¼", next: "ending_suzuki" }
                ]
            },
            ending_tanaka: {
                text: "å›ãŒç”°ä¸­ã‚’çªãã¤ã‘ã‚‹ã¨ã€å½¼ã¯è¦³å¿µã—ãŸã‚ˆã†ã«ç¬‘ã£ãŸã€‚ã€Œãã†ã ã€‚ç§ãŒã‚„ã£ãŸã€‚äº‹æ¥­ã‚’ä¹—ã£å–ã‚ã†ã¨ã—ã¦ã„ã‚‹ã“ã¨ã«å±±ä¸‹ãŒæ°—ã¥ã„ãŸã‹ã‚‰ã ã€‚è„…è¿«çŠ¶ã§éˆ´æœ¨ã«ç½ªã‚’ãªã™ã‚Šã¤ã‘ã€å½¼å¥³ã®ãƒŠã‚¤ãƒ•ã§...ã€è¦‹äº‹ãªæ¨ç†ã ã€‚äº‹ä»¶ã¯è§£æ±ºã—ãŸã€‚",
                sceneBuilder: () => buildEndingScene(true),
                isEnding: true,
                condition: () => inventory.has("è„…è¿«çŠ¶") && inventory.has("ãƒŠã‚¤ãƒ•ã¯éˆ´æœ¨ã®ã‚‚ã®") && inventory.has("éˆ´æœ¨ã¯ç”°ä¸­ãŒçŠ¯äººã ã¨ä¸»å¼µ"),
                fallback: "ending_fail_tanaka"
            },
            ending_suzuki: {
                text: "å›ãŒéˆ´æœ¨ã‚’çŠ¯äººã ã¨å‘Šç™ºã™ã‚‹ã¨ã€å½¼å¥³ã¯æ³£ãå´©ã‚ŒãŸã€‚ã€Œé•ã†...ç§ã˜ã‚ƒãªã„...ã€ãã®å¾Œã€çœŸçŠ¯äººã§ã‚ã‚‹ç”°ä¸­ã¯æµ·å¤–ã¸é«˜é£›ã³ã—ã€äº‹ä»¶ã¯è¿·å®®å…¥ã‚Šã¨ãªã£ãŸã€‚å›ã®æ¨ç†ã¯é–“é•ã£ã¦ã„ãŸã€‚",
                sceneBuilder: () => buildEndingScene(false),
                isEnding: true
            },
            ending_fail_tanaka: {
                text: "å›ã¯ç”°ä¸­ã‚’å‘Šç™ºã—ãŸãŒã€æ±ºå®šçš„ãªè¨¼æ‹ ãŒè¶³ã‚Šãªã‹ã£ãŸã€‚ã€Œé¦¬é¹¿ãªã“ã¨ã‚’ã€‚è¨¼æ‹ ã§ã‚‚ã‚ã‚‹ã®ã‹ã­ï¼Ÿã€å½¼ã¯å¼è­·å£«ã‚’å‘¼ã³ã€å›ã¯æ‹…å½“ã‚’å¤–ã•ã‚ŒãŸã€‚çœŸçŠ¯äººã¯é—‡ã®ä¸­ã«æ¶ˆãˆãŸã€‚",
                sceneBuilder: () => buildEndingScene(false),
                isEnding: true
            }
        };

        function startGame() {
            showScene('start');
        }

        function showScene(sceneId) {
            const sceneData = story[sceneId];
            
            if (sceneData.isEnding && sceneData.condition && !sceneData.condition()) {
                showScene(sceneData.fallback);
                return;
            }

            if (sceneData.sceneBuilder) {
                sceneData.sceneBuilder();
            }

            textContainer.innerHTML = `<p>${sceneData.text}</p>`;
            choicesContainer.innerHTML = '';

            if (sceneData.onEnter) {
                sceneData.onEnter();
            }

            if (sceneData.isEnding) {
                const restartButton = document.createElement('button');
                restartButton.innerText = 'ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ã™ã‚‹';
                restartButton.className = 'w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-4 rounded-lg transition-all duration-200 choice-button';
                restartButton.onclick = () => {
                    inventory.clear();
                    updateInventory();
                    startGame();
                };
                choicesContainer.appendChild(restartButton);
            } else {
                sceneData.choices.forEach(choice => {
                    if (choice.condition === undefined || choice.condition()) {
                        const button = document.createElement('button');
                        button.innerText = choice.text;
                        button.className = 'w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 choice-button';
                        button.onclick = () => showScene(choice.next);
                        choicesContainer.appendChild(button);
                    }
                });
            }
        }

        function addInventory(item) {
            inventory.add(item);
            updateInventory();
        }

        function updateInventory() {
            inventoryList.innerHTML = '';
            if (inventory.size === 0) {
                inventoryList.appendChild(noEvidence);
            } else {
                inventory.forEach(item => {
                    const li = document.createElement('li');
                    li.className = "bg-slate-800 px-3 py-1 rounded-full text-sm";
                    li.innerText = `ğŸ“„ ${item}`;
                    inventoryList.appendChild(li);
                });
            }
        }

        // --- Start Game ---
        init3D();
        startGame();

    </script>
</body>
</html>
